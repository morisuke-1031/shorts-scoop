name: make-rank-video

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1,13 * * *"   # JST 10:00 / 22:00（UTC 01:00 / 13:00）

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug workspace
        run: |
          echo "PWD:"
          pwd
          echo "LS root:"
          ls -la
          echo "LS scripts:"
          ls -la scripts || true
          echo "Find make_rank_video.py:"
          find . -maxdepth 4 -type f -name "make_rank_video.py" -print

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Download assets
        run: |
          mkdir -p Automovei
          curl -L -o Automovei/bg.wmv  "${{ secrets.BG_URL }}"
          curl -L -o Automovei/bgm.wav "${{ secrets.BGM_URL }}"
          ls -la Automovei

      - name: Generate rank video
        run: |
          python ./scripts/make_rank_video.py \
            --latest_json ./latest.json \
            --bg ./Automovei/bg.wmv \
            --bgm ./Automovei/bgm.wav \
            --out ./Automovei/out/rank.mp4 \
            --seconds 15

      - name: Upload artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: rank-video
          path: Automovei/out/rank.mp4
          retention-days: 3
